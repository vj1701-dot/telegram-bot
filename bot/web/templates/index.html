<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Audio Bot</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 30px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }
        .tab-content { display: none; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        input[type="text"], input[type="password"], input[type="time"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        button:hover { background: #0056b3; }
        .success { background: #d4edda; color: #155724; padding: 12px; border-radius: 4px; margin-bottom: 20px; }
        .error { background: #f8d7da; color: #721c24; padding: 12px; border-radius: 4px; margin-bottom: 20px; }
        .info { background: #d1ecf1; color: #0c5460; padding: 12px; border-radius: 4px; margin-bottom: 20px; }
        .bot-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value { font-size: 32px; font-weight: bold; color: #007bff; }
        .stat-label { color: #666; margin-top: 5px; }
        .file-upload {
            border: 2px dashed #ddd;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
        }
        .file-upload:hover { border-color: #007bff; background: #f8f9fa; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close {
            font-size: 28px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
        }
        .close:hover { color: #000; }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn-edit {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-edit:hover { background: #218838; }
        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-delete:hover { background: #c82333; }
        .schedule-checkboxes {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .schedule-checkbox {
            display: block;
            margin-bottom: 8px;
        }
        .schedule-order-list {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background: white;
            min-height: 100px;
        }
        .schedule-order-list h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }
        .schedule-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
        }
        .schedule-item:hover {
            background: #e9ecef;
            border-color: #007bff;
        }
        .schedule-item.dragging {
            opacity: 0.5;
        }
        .schedule-order-num {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background: #007bff;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
            margin-right: 8px;
        }
        .schedule-name {
            flex: 1;
        }
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-small:hover {
            background: #0056b3;
        }
        .btn-remove {
            background: #dc3545;
        }
        .btn-remove:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è Telegram Audio Bot</h1>

        <div class="tabs">
            <button class="tab active" onclick="showTab('home')">Home</button>
            <button class="tab" onclick="showTab('config')">Configuration</button>
            <button class="tab" onclick="showTab('files')">Upload Files</button>
            <button class="tab" onclick="showTab('schedule')">Schedule</button>
            <button class="tab" onclick="showTab('manual')">Manual Send</button>
        </div>

        <!-- Home Tab -->
        <div id="home" class="tab-content active">
            <h2>Status Dashboard</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="bot-count">-</div>
                    <div class="stat-label">Active Bots</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="schedule-status">-</div>
                    <div class="stat-label">Schedule Status</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="file-count">-</div>
                    <div class="stat-label">Audio Files</div>
                </div>
            </div>
            <div class="info">
                <strong>Quick Links:</strong><br>
                - API Documentation: <a href="/docs">/docs</a><br>
                - Health Check: <a href="/health">/health</a>
            </div>
        </div>

        <!-- Configuration Tab -->
        <div id="config" class="tab-content">
            <h2>Bot Configuration</h2>
            <form id="add-bot-form">
                <div class="form-group">
                    <label>Bot Token</label>
                    <input type="password" name="bot_token" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11" required>
                </div>
                <div class="form-group">
                    <label>Chat ID</label>
                    <input type="text" name="chat_id" placeholder="-1001234567890" required>
                </div>
                <div class="form-group">
                    <label>Scheduler Time (daily send time)</label>
                    <input type="time" name="scheduler_time" value="09:00" required>
                </div>
                <div class="form-group">
                    <label>Select Schedules (click to add, drag to reorder)</label>
                    <div id="add-bot-schedules-available" class="schedule-checkboxes">
                        <p style="color: #666;">Loading schedules...</p>
                    </div>
                    <div id="add-bot-schedules-selected" class="schedule-order-list" style="margin-top: 10px;">
                        <h4>Selected Schedules (in order):</h4>
                        <p style="color: #999; font-size: 13px;" id="add-no-schedules">No schedules selected</p>
                    </div>
                </div>
                <button type="submit">Add Bot</button>
            </form>

            <h3 style="margin-top: 40px;">Configured Bots</h3>
            <div id="bots-list"></div>
        </div>

        <!-- Edit Bot Modal -->
        <div id="edit-bot-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Bot Configuration</h2>
                    <span class="close" onclick="closeEditModal()">&times;</span>
                </div>
                <form id="edit-bot-form">
                    <input type="hidden" id="edit-bot-token" name="bot_token">
                    <div class="form-group">
                        <label>Chat ID</label>
                        <input type="text" id="edit-chat-id" name="chat_id" required>
                    </div>
                    <div class="form-group">
                        <label>Scheduler Time</label>
                        <input type="time" id="edit-scheduler-time" name="scheduler_time" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="edit-enabled" name="enabled">
                            Enabled
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Select Schedules (click to add, drag to reorder)</label>
                        <div id="edit-bot-schedules-available" class="schedule-checkboxes">
                            <p style="color: #666;">Loading schedules...</p>
                        </div>
                        <div id="edit-bot-schedules-selected" class="schedule-order-list" style="margin-top: 10px;">
                            <h4>Selected Schedules (in order):</h4>
                            <p style="color: #999; font-size: 13px;" id="edit-no-schedules">No schedules selected</p>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn-edit">Save Changes</button>
                        <button type="button" onclick="closeEditModal()" style="background: #6c757d;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Upload Files Tab -->
        <div id="files" class="tab-content">
            <h2>Upload Audio Files</h2>
            <div class="form-group">
                <label>Target Folder</label>
                <input type="text" id="upload-folder" value="audio/" placeholder="audio/">
                <small style="color: #666;">Files will be uploaded to /data/{folder}/</small>
            </div>
            <div class="file-upload" onclick="document.getElementById('file-input').click()">
                <p>üìÅ Click to select audio files</p>
                <p style="color: #666; font-size: 14px;">Supported: MP3, OGG, OPUS, WAV, M4A</p>
                <input type="file" id="file-input" multiple accept=".mp3,.ogg,.opus,.wav,.m4a" style="display:none" onchange="uploadFiles()">
            </div>
            <div id="upload-status"></div>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content">
            <h2>Schedule Editor</h2>
            <div class="info">
                Manage multiple schedule files. The bot reads all enabled schedules.
            </div>

            <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                <label style="font-weight: bold;">Current Schedule:</label>
                <select id="schedule-selector" onchange="switchSchedule()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    <option value="schedule.xlsx">schedule.xlsx (default)</option>
                </select>
                <button onclick="createNewSchedule()">‚ûï New Schedule</button>
            </div>

            <div style="margin-bottom: 20px;">
                <button onclick="addScheduleRow()">‚ûï Add Row</button>
                <button onclick="saveSchedule()">üíæ Save Schedule</button>
                <button onclick="downloadSchedule()">üì• Download Excel</button>
                <button onclick="deleteCurrentSchedule()" style="background: #dc3545;">üóëÔ∏è Delete Schedule</button>
            </div>

            <div style="overflow-x: auto;">
                <table id="schedule-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #ddd;">Date</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Path</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Track Name</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Enabled</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <hr style="margin: 30px 0;">
            <h3>Or Upload Excel File</h3>
            <div class="form-group">
                <input type="file" id="schedule-file" accept=".xlsx">
                <button onclick="uploadSchedule()">üì§ Upload & Replace</button>
            </div>
        </div>

        <!-- Manual Send Tab -->
        <div id="manual" class="tab-content">
            <h2>Manual Send</h2>
            <form id="manual-send-form">
                <div class="form-group">
                    <label>Date (YYYY-MM-DD)</label>
                    <input type="text" name="date" placeholder="2024-01-15" required>
                </div>
                <button type="submit">Send Audio for Date</button>
            </form>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'home') loadStatus();
            if (tabName === 'config') loadBots();
            if (tabName === 'schedule') loadSchedule();
        }

        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                document.getElementById('bot-count').textContent = data.bot_count || 0;
                document.getElementById('schedule-status').textContent = data.schedule_exists ? '‚úì' : '‚úó';
                document.getElementById('file-count').textContent = data.file_count || 0;
            } catch (e) {
                console.error('Failed to load status', e);
            }
        }

        let availableSchedules = [];

        async function loadAvailableSchedules() {
            try {
                const response = await fetch('/api/schedules/list');
                const data = await response.json();
                availableSchedules = data.schedules || [];
                return availableSchedules;
            } catch (e) {
                console.error('Failed to load schedules', e);
                return [];
            }
        }

        // Schedule ordering system
        let addBotSelectedSchedules = [];
        let editBotSelectedSchedules = [];

        function renderScheduleSelector(prefix, selectedSchedules = []) {
            const availableContainer = document.getElementById(`${prefix}-schedules-available`);
            const selectedContainer = document.getElementById(`${prefix}-schedules-selected`);
            const noSchedulesMsg = document.getElementById(`${prefix}-no-schedules`);

            if (!availableSchedules.length) {
                availableContainer.innerHTML = '<p style="color: #999;">No schedules available</p>';
                return;
            }

            // Store selected schedules
            if (prefix === 'add-bot') {
                addBotSelectedSchedules = [...selectedSchedules];
            } else {
                editBotSelectedSchedules = [...selectedSchedules];
            }

            // Render available schedules (not yet selected)
            availableContainer.innerHTML = availableSchedules
                .filter(s => !selectedSchedules.includes(s))
                .map(schedule => `
                    <div class="schedule-item" onclick="addScheduleToBot('${prefix}', '${schedule}')" style="cursor: pointer;">
                        <span>${schedule}</span>
                        <button class="btn-small" onclick="event.stopPropagation(); addScheduleToBot('${prefix}', '${schedule}')">+ Add</button>
                    </div>
                `).join('') || '<p style="color: #999; font-size: 13px;">All schedules selected</p>';

            // Render selected schedules (in order)
            if (selectedSchedules.length === 0) {
                selectedContainer.innerHTML = '<h4>Selected Schedules (in order):</h4><p style="color: #999; font-size: 13px;" id="' + prefix + '-no-schedules">No schedules selected</p>';
            } else {
                selectedContainer.innerHTML = '<h4>Selected Schedules (in order):</h4>' +
                    selectedSchedules.map((schedule, index) => `
                        <div class="schedule-item" draggable="true" ondragstart="dragStart(event, ${index}, '${prefix}')" ondragover="allowDrop(event)" ondrop="drop(event, ${index}, '${prefix}')" data-index="${index}">
                            <div>
                                <span class="schedule-order-num">${index + 1}</span>
                                <span class="schedule-name">${schedule}</span>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                ${index > 0 ? `<button class="btn-small" onclick="moveSchedule('${prefix}', ${index}, -1)">‚ñ≤</button>` : ''}
                                ${index < selectedSchedules.length - 1 ? `<button class="btn-small" onclick="moveSchedule('${prefix}', ${index}, 1)">‚ñº</button>` : ''}
                                <button class="btn-small btn-remove" onclick="removeScheduleFromBot('${prefix}', '${schedule}')">√ó</button>
                            </div>
                        </div>
                    `).join('');
            }
        }

        function addScheduleToBot(prefix, schedule) {
            const selected = prefix === 'add-bot' ? addBotSelectedSchedules : editBotSelectedSchedules;
            if (!selected.includes(schedule)) {
                selected.push(schedule);
                renderScheduleSelector(prefix, selected);
            }
        }

        function removeScheduleFromBot(prefix, schedule) {
            const selected = prefix === 'add-bot' ? addBotSelectedSchedules : editBotSelectedSchedules;
            const index = selected.indexOf(schedule);
            if (index > -1) {
                selected.splice(index, 1);
                renderScheduleSelector(prefix, selected);
            }
        }

        function moveSchedule(prefix, index, direction) {
            const selected = prefix === 'add-bot' ? addBotSelectedSchedules : editBotSelectedSchedules;
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < selected.length) {
                [selected[index], selected[newIndex]] = [selected[newIndex], selected[index]];
                renderScheduleSelector(prefix, selected);
            }
        }

        // Drag and drop functions
        let draggedIndex = null;
        let draggedPrefix = null;

        function dragStart(event, index, prefix) {
            draggedIndex = index;
            draggedPrefix = prefix;
            event.target.classList.add('dragging');
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function drop(event, dropIndex, prefix) {
            event.preventDefault();
            if (draggedPrefix === prefix && draggedIndex !== null && draggedIndex !== dropIndex) {
                const selected = prefix === 'add-bot' ? addBotSelectedSchedules : editBotSelectedSchedules;
                const [draggedItem] = selected.splice(draggedIndex, 1);
                selected.splice(dropIndex, 0, draggedItem);
                renderScheduleSelector(prefix, selected);
            }
            draggedIndex = null;
            draggedPrefix = null;
            document.querySelectorAll('.schedule-item').forEach(item => item.classList.remove('dragging'));
        }

        async function loadBots() {
            try {
                await loadAvailableSchedules();
                renderScheduleSelector('add-bot', []);

                const response = await fetch('/api/bots');
                const bots = await response.json();
                const list = document.getElementById('bots-list');
                list.innerHTML = bots.map(bot => {
                    const schedules = bot.schedules || ['schedule.xlsx'];
                    const schedulesList = schedules.map((s, i) => `<span style="display: inline-block; margin-right: 10px;"><span class="schedule-order-num" style="width: 20px; height: 20px; line-height: 20px; font-size: 11px;">${i + 1}</span> ${s}</span>`).join('');
                    return `
                        <div class="bot-card">
                            <strong>Token:</strong> ${bot.bot_token.substring(0, 10)}...<br>
                            <strong>Chat ID:</strong> ${bot.chat_id}<br>
                            <strong>Schedule Time:</strong> ${bot.scheduler_time}<br>
                            <strong>Enabled:</strong> ${bot.enabled ? '‚úì' : '‚úó'}<br>
                            <strong>Schedules (in order):</strong><br>
                            <div style="margin-top: 8px;">${schedulesList}</div>
                            <div class="btn-group">
                                <button class="btn-edit" onclick='editBot(${JSON.stringify(bot)})'>‚úèÔ∏è Edit</button>
                                <button class="btn-delete" onclick="deleteBot('${bot.bot_token}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load bots', e);
            }
        }

        function editBot(bot) {
            document.getElementById('edit-bot-token').value = bot.bot_token;
            document.getElementById('edit-chat-id').value = bot.chat_id;
            document.getElementById('edit-scheduler-time').value = bot.scheduler_time;
            document.getElementById('edit-enabled').checked = bot.enabled;

            renderScheduleSelector('edit-bot', bot.schedules || ['schedule.xlsx']);

            document.getElementById('edit-bot-modal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('edit-bot-modal').style.display = 'none';
        }

        async function deleteBot(botToken) {
            if (!confirm('Are you sure you want to delete this bot configuration?')) {
                return;
            }

            try {
                const response = await fetch(`/api/bots/${encodeURIComponent(botToken)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Bot deleted successfully!');
                    loadBots();
                } else {
                    const error = await response.json();
                    alert('Failed to delete bot: ' + (error.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        document.getElementById('add-bot-form').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            // Use the ordered selected schedules
            formData.append('schedules', JSON.stringify(addBotSelectedSchedules));

            try {
                const response = await fetch('/api/bots', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('Bot added successfully!');
                    e.target.reset();
                    addBotSelectedSchedules = [];
                    loadBots();
                } else {
                    const error = await response.json();
                    alert('Failed to add bot: ' + (error.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        };

        document.getElementById('edit-bot-form').onsubmit = async (e) => {
            e.preventDefault();
            const botToken = document.getElementById('edit-bot-token').value;
            const formData = new FormData();

            formData.append('chat_id', document.getElementById('edit-chat-id').value);
            formData.append('scheduler_time', document.getElementById('edit-scheduler-time').value);
            formData.append('enabled', document.getElementById('edit-enabled').checked);

            // Use the ordered selected schedules
            formData.append('schedules', JSON.stringify(editBotSelectedSchedules));

            try {
                const response = await fetch(`/api/bots/${encodeURIComponent(botToken)}`, {
                    method: 'PUT',
                    body: formData
                });

                if (response.ok) {
                    alert('Bot updated successfully!');
                    closeEditModal();
                    editBotSelectedSchedules = [];
                    loadBots();
                } else {
                    const error = await response.json();
                    alert('Failed to update bot: ' + (error.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        };

        async function uploadFiles() {
            const files = document.getElementById('file-input').files;
            const folder = document.getElementById('upload-folder').value;
            const status = document.getElementById('upload-status');

            if (!files.length) return;

            status.innerHTML = '<div class="info">Uploading...</div>';

            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('folder', folder);

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        status.innerHTML += `<div class="success">‚úì ${file.name} uploaded</div>`;
                    } else {
                        status.innerHTML += `<div class="error">‚úó ${file.name} failed</div>`;
                    }
                } catch (e) {
                    status.innerHTML += `<div class="error">‚úó ${file.name} error: ${e.message}</div>`;
                }
            }
        }

        async function uploadSchedule() {
            const file = document.getElementById('schedule-file').files[0];
            if (!file) return alert('Please select a file');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/schedule', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('Schedule uploaded successfully!');
                    loadSchedule(); // Reload the table
                } else {
                    alert('Failed to upload schedule');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        let scheduleData = [];
        let currentScheduleFile = 'schedule.xlsx';

        async function loadScheduleList() {
            try {
                const response = await fetch('/api/schedules/list');
                const data = await response.json();
                const selector = document.getElementById('schedule-selector');

                selector.innerHTML = data.schedules.map(name =>
                    `<option value="${name}" ${name === currentScheduleFile ? 'selected' : ''}>${name}</option>`
                ).join('');
            } catch (e) {
                console.error('Failed to load schedule list', e);
            }
        }

        async function loadSchedule(filename = currentScheduleFile) {
            try {
                const response = await fetch(`/api/schedule/data?filename=${filename}`);
                const data = await response.json();
                scheduleData = data.rows || [];
                currentScheduleFile = data.filename || filename;
                renderScheduleTable();
                await loadScheduleList();
            } catch (e) {
                console.error('Failed to load schedule', e);
                document.getElementById('schedule-body').innerHTML =
                    '<tr><td colspan="5" style="text-align: center; padding: 20px; color: red;">Failed to load schedule</td></tr>';
            }
        }

        function switchSchedule() {
            const selector = document.getElementById('schedule-selector');
            currentScheduleFile = selector.value;
            loadSchedule(currentScheduleFile);
        }

        async function createNewSchedule() {
            const filename = prompt('Enter new schedule filename (without .xlsx):');
            if (!filename) return;

            try {
                const formData = new FormData();
                formData.append('filename', filename);

                const response = await fetch('/api/schedule/create', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úì Created new schedule: ${result.filename}`);
                    currentScheduleFile = result.filename;
                    await loadSchedule(currentScheduleFile);
                } else {
                    const error = await response.json();
                    alert('Failed to create schedule: ' + error.detail);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteCurrentSchedule() {
            if (currentScheduleFile === 'schedule.xlsx') {
                alert('Cannot delete the default schedule!');
                return;
            }

            if (!confirm(`Delete ${currentScheduleFile}?`)) return;

            try {
                const formData = new FormData();
                formData.append('filename', currentScheduleFile);

                const response = await fetch('/api/schedule/delete', {
                    method: 'DELETE',
                    body: formData
                });

                if (response.ok) {
                    alert(`‚úì Deleted ${currentScheduleFile}`);
                    currentScheduleFile = 'schedule.xlsx';
                    await loadSchedule(currentScheduleFile);
                } else {
                    const error = await response.json();
                    alert('Failed to delete: ' + error.detail);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function renderScheduleTable() {
            const tbody = document.getElementById('schedule-body');

            if (scheduleData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No schedule entries. Click "Add Row" to start.</td></tr>';
                return;
            }

            tbody.innerHTML = scheduleData.map((row, index) => `
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="date" value="${row.Date || ''}"
                               onchange="updateScheduleRow(${index}, 'Date', this.value)"
                               style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="text" value="${row.Path || 'audio/'}"
                               onchange="updateScheduleRow(${index}, 'Path', this.value)"
                               style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="text" value="${row['Track Name'] || ''}"
                               onchange="updateScheduleRow(${index}, 'Track Name', this.value)"
                               style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <input type="checkbox" ${row.Enabled ? 'checked' : ''}
                               onchange="updateScheduleRow(${index}, 'Enabled', this.checked)"
                               style="width: 20px; height: 20px; cursor: pointer;">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <button onclick="deleteScheduleRow(${index})"
                                style="background: #dc3545; padding: 5px 10px; font-size: 12px;">üóëÔ∏è Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateScheduleRow(index, field, value) {
            scheduleData[index][field] = value;
        }

        function addScheduleRow() {
            const today = new Date().toISOString().split('T')[0];
            scheduleData.push({
                'Date': today,
                'Path': 'audio/',
                'Track Name': '',
                'Enabled': true
            });
            renderScheduleTable();
        }

        function deleteScheduleRow(index) {
            if (confirm('Delete this row?')) {
                scheduleData.splice(index, 1);
                renderScheduleTable();
            }
        }

        async function saveSchedule() {
            try {
                const formData = new FormData();
                formData.append('rows', JSON.stringify(scheduleData));
                formData.append('filename', currentScheduleFile);

                const response = await fetch('/api/schedule/data', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úì Schedule saved successfully! ${result.rows} rows saved to ${result.filename}`);
                } else {
                    const error = await response.json();
                    alert('Failed to save schedule: ' + (error.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('Error saving schedule: ' + e.message);
            }
        }

        function downloadSchedule() {
            window.location.href = '/api/schedule';
        }

        document.getElementById('manual-send-form').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/api/send-manual', {
                    method: 'POST',
                    body: formData  // Send FormData directly
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Audio sent successfully! Sent ${result.count} file(s) for date ${result.date}`);
                } else {
                    alert('Failed to send audio');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        };

        // Load status on page load
        loadStatus();
    </script>
</body>
</html>
